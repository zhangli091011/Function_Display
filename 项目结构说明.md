# 项目结构说明

## 文件组织

```
math-calculator/
│
├── main.py              # 程序入口，启动 PyQt5 应用
├── ui.py                # 用户界面模块（PyQt5）
├── lexer.py             # 词法分析器
├── parser.py            # 语法分析器（生成 AST）
├── evaluator.py         # 表达式求值器
├── derivative.py        # 符号求导器
├── plotter.py           # 函数绘图器（Matplotlib）
│
├── test_calculator.py   # 核心功能测试脚本
├── requirements.txt     # Python 依赖列表
├── README.md            # 项目说明
├── 使用说明.md          # 详细使用指南
└── 项目结构说明.md      # 本文件
```

## 模块详解

### 1. lexer.py - 词法分析器

**职责**：将输入字符串转换为 Token 序列

**核心类**：
- `TokenType`：Token 类型枚举（数字、变量、运算符、函数等）
- `Token`：Token 数据结构
- `Lexer`：词法分析器主类

**关键方法**：
- `tokenize()`：将字符串转换为 Token 列表
- `read_number()`：读取数字（支持小数）
- `read_identifier()`：读取标识符（函数名、变量名）

**示例**：
```python
lexer = Lexer("x^2 + sin(x)")
tokens = lexer.tokenize()
# 输出：[VARIABLE(x), POWER, NUMBER(2), PLUS, SIN, LPAREN, VARIABLE(x), RPAREN, EOF]
```

---

### 2. parser.py - 语法分析器

**职责**：将 Token 序列转换为抽象语法树（AST）

**核心类**：
- `ASTNode`：AST 节点基类
- `NumberNode`：数字节点
- `VariableNode`：变量节点
- `BinaryOpNode`：二元运算节点
- `UnaryOpNode`：一元运算节点
- `FunctionNode`：函数节点
- `Parser`：语法分析器主类

**解析方法（递归下降）**：
- `expression()`：处理加减法（最低优先级）
- `term()`：处理乘除法
- `power()`：处理幂运算（右结合）
- `factor()`：处理因子（数字、变量、函数、括号）
- `function_call()`：处理函数调用

**运算优先级**：
```
() > 函数 > ^ > * / > + -
```

**示例**：
```python
parser = Parser(tokens)
ast = parser.parse()
# 生成 AST：BinOp(BinOp(x, ^, 2), +, Func(sin, [x]))
```

---

### 3. evaluator.py - 表达式求值器

**职责**：遍历 AST 并计算数值结果

**核心类**：
- `Evaluator`：求值器主类

**关键方法**：
- `evaluate(node)`：递归求值 AST 节点
- `eval_number()`：求值数字（包括 π、e）
- `eval_variable()`：求值变量 x
- `eval_binary_op()`：求值二元运算
- `eval_function()`：求值函数（sin、cos、log）

**辅助函数**：
- `format_result(value)`：智能格式化输出
  - 优先级：整数 > π/e 倍数 > 分数 > 小数

**示例**：
```python
evaluator = Evaluator(x_value=3.14159)
result = evaluator.evaluate(ast)
formatted = format_result(result)  # "π²" 或 "9.8696"
```

---

### 4. derivative.py - 符号求导器

**职责**：对 AST 进行符号求导，返回导函数的 AST

**核心类**：
- `Derivative`：求导器主类

**求导规则**：
- 常数：`c' = 0`
- 变量：`x' = 1`
- 加减法：`(f ± g)' = f' ± g'`
- 乘法：`(f * g)' = f' * g + f * g'`（乘法法则）
- 除法：`(f / g)' = (f' * g - f * g') / g²`（商法则）
- 幂函数：`(x^n)' = n * x^(n-1)`
- 指数函数：`(a^x)' = a^x * ln(a)`
- 三角函数：
  - `sin(f)' = cos(f) * f'`
  - `cos(f)' = -sin(f) * f'`
- 对数函数：
  - `ln(f)' = f' / f`
  - `log_a(f)' = f' / (f * ln(a))`

**辅助函数**：
- `ast_to_string(node)`：将 AST 转换为可读字符串

**示例**：
```python
derivative_ast = Derivative.differentiate(ast)
derivative_str = ast_to_string(derivative_ast)
# 输出："2*x + cos(x)"
```

---

### 5. plotter.py - 函数绘图器

**职责**：使用 Matplotlib 绘制函数图像

**核心类**：
- `FunctionPlotter`：绘图器主类

**关键方法**：
- `plot_function(ast, ...)`：绘制函数图像
  - 参数：AST、x 范围、颜色、线型、标签
- `clear()`：清除所有图像
- `setup_axes()`：设置坐标轴

**绘图特性**：
- 标准二维直角坐标系
- 自动处理无效值（NaN、Inf）
- 支持多条曲线叠加
- 图例显示

**示例**：
```python
plotter = FunctionPlotter(canvas)
plotter.plot_function(ast, label='f(x)', color='blue')
plotter.plot_function(deriv_ast, label="f'(x)", color='red', linestyle='--')
```

---

### 6. ui.py - 用户界面

**职责**：构建 PyQt5 图形界面，整合所有模块

**核心类**：
- `CalculatorWindow`：主窗口类

**界面组件**：
- 函数输入框（QLineEdit）
- x 值输入框（QLineEdit）
- 结果显示区（QTextEdit）
- 按钮网格（QGridLayout）
- 绘图画布（Matplotlib FigureCanvas）

**按钮功能**：
- 数字键：0-9、小数点
- 运算符：+ - * / ^
- 函数键：sin、cos、log、π、e
- 控制键：= 计算、绘图、求导、清除
- 编辑键：← → 光标移动、退格

**事件处理**：
- `calculate()`：数值计算
- `plot_function()`：绘制函数
- `compute_derivative()`：计算导数
- `plot_derivative()`：绘制导函数

---

### 7. main.py - 程序入口

**职责**：启动 PyQt5 应用程序

```python
def main():
    app = QApplication(sys.argv)
    window = CalculatorWindow()
    window.show()
    sys.exit(app.exec_())
```

---

## 数据流程

### 数值计算流程
```
用户输入 "x^2 + sin(x)", x=π
    ↓
Lexer: 字符串 → Token 序列
    ↓
Parser: Token 序列 → AST
    ↓
Evaluator: AST + x值 → 数值结果
    ↓
format_result: 数值 → 格式化字符串 "π²"
    ↓
显示结果
```

### 求导流程
```
用户输入 "x^2 + sin(x)"
    ↓
Lexer + Parser: 字符串 → AST
    ↓
Derivative: AST → 导数 AST
    ↓
ast_to_string: 导数 AST → 字符串 "2*x + cos(x)"
    ↓
显示导函数
```

### 绘图流程
```
用户输入 "x^2"
    ↓
Lexer + Parser: 字符串 → AST
    ↓
Plotter: 
  - 生成 x 值数组 [-10, 10]
  - 对每个 x 调用 Evaluator
  - 收集 y 值
  - 使用 Matplotlib 绘制
    ↓
显示图像
```

---

## 扩展点

### 1. 添加新函数
在 `lexer.py` 中添加新的 TokenType，在 `parser.py` 中处理解析，在 `evaluator.py` 中实现求值，在 `derivative.py` 中实现求导规则。

### 2. 表达式简化
在 `derivative.py` 中添加 `simplify(ast)` 函数，实现常数折叠、同类项合并等。

### 3. 更多绘图功能
在 `plotter.py` 中添加：
- 极值点标注
- 切线绘制
- 区间积分面积填充

### 4. 保存/加载功能
在 `ui.py` 中添加文件对话框，保存函数表达式和图像。

---

## 设计原则

1. **模块化**：每个模块职责单一，便于维护和测试
2. **可扩展**：使用 AST 结构，易于添加新功能
3. **教学导向**：输出格式优化，适合教学演示
4. **无外部依赖**：不调用在线 API，完全本地计算

---

## 测试策略

### 单元测试
- `test_calculator.py`：测试核心功能
- 覆盖：词法分析、语法分析、求值、求导

### 集成测试
- 通过 UI 手动测试完整流程
- 验证各模块协同工作

### 测试用例
```python
# 基础函数
"x^2" → 求导 → "2*x"
"sin(x)" → 求导 → "cos(x)"

# 复合函数
"sin(x^2)" → 求导 → "cos(x^2) * 2*x"

# 边界情况
"log(0)" → 错误提示
"1/0" → 错误提示
```

---

## 性能考虑

- **词法分析**：O(n)，n 为字符串长度
- **语法分析**：O(n)，递归下降
- **求值**：O(m)，m 为 AST 节点数
- **绘图**：O(k)，k 为采样点数（默认 1000）

总体性能：对于常见表达式，响应时间 < 100ms

---

## 依赖关系

```
main.py
  └── ui.py
       ├── lexer.py
       ├── parser.py
       │    └── lexer.py
       ├── evaluator.py
       │    └── parser.py
       ├── derivative.py
       │    └── parser.py
       └── plotter.py
            └── evaluator.py
```

---

## 代码规范

- **命名**：使用描述性名称，遵循 PEP 8
- **注释**：每个类和关键方法都有中文注释
- **错误处理**：使用 try-except 捕获异常，提供友好提示
- **类型提示**：关键函数使用类型注解（可选）

---

## 未来规划（Phase 2）

1. **表达式简化**：自动化简导数表达式
2. **更多函数**：tan、arcsin、arccos、sqrt、abs
3. **隐式乘法**：支持 `2x` → `2*x`
4. **函数库**：预定义常用函数
5. **导出功能**：保存图像为 PNG/PDF
6. **步骤显示**：显示求导过程
7. **多语言**：支持英文界面
